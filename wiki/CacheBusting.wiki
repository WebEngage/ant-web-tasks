#summary Attributes and samples on how to use the <cacheBuster> inside PowerWAR
#labels Featured

== Introduction ==
 # [#What_is_cache_busting? What is cache busting?]
 # [#Cache_Busting_Attributes Cache Busting Attributes]
 # [#Cache_Busting_Nested_Elements Cache Busting Nested Elements]
 # [#Cache_Busting_Samples Cache Busting Samples]

== What is cache busting? ==
By cache, here I always mean HTTP Cache. HTTP Cache comes as a huge boon for performance. Clients (Browsers) typically store a copy of the HTTP Response and serve it from their caches unless instructed otherwise. In typical scenarios, this works very well. However, you run into a problem when you want to invalidate this cache. There are very few ways to achieve this. Cache Busting is one of the solutions to this problem in which a random string is appended to the HTTP Request URL, thereby "faking" an altogether new URL. The browser is forced to make a request as the URL itself has changed.

The PowerWAR task of this Ant contribution lets you achieve this from the comfort of your build.xml file. Underneath is a simple example -
{{{
<taskdef name="powerWar" classname="com.avlesh.antwebtasks.war.PowerWAR" classpath="/path/to/ant-web-tasks.jar"/>
<target name="my-war-target">
  <powerWar destfile="distribution/myapp.war" webxml="web/WEB-INF/web.xml" compress="true">

    <cacheBuster verbose="on" versionFile="version.txt">
      <fileset dir="web"/>
      <rule from="/mysite/css/(.*).css" 
              to="/mysite/css/(.*).css?random=%{version-file-txt}"/>
    </cacheBuster>
    
    ...
  </powerWar>
</target>
}}}

=== Cache Busting Attributes ===
<table cellspacing="0" cellpadding="10" border="1" width="800">
 <tr>
  <td width="100" valign="top" align="left"><b>Attribute</b></td>
  <td width="500" valign="top" align="left"><b>Description</b></td>
  <td width="200" valign="top" align="left"><b>Remarks</b></td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{versionFile}}}</td>
  <td width="500" valign="top" align="left">A file which is supposed to store the version (or revision or build number) for the project. The {{{cacheBuster}}} simply picks up this value and populates the replacement variable {{{ %{version-file-txt}. }}}
<br/><br/>
This file can be a java properties file too. Look at {{{versionPropertyKey}}} for details.</td>
  <td valign="top" align="left">Default: {{{none}}}<br/>Mandatory.</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{createVersionFileIfNotExists}}}</td>
  <td width="500" valign="top" align="left">When set to {{{true}}}, creates the {{{versionFile}}} if it does not exist. Starting version number in the file is set to 1.</td>
  <td valign="top" align="left">Default: {{{true}}}</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{autoIncrementVersionNumber}}}</td>
  <td width="500" valign="top" align="left">You may want to use this attribute, when you are not managing the version file yourself. When set to {{{true}}}, the {{{<cacheBuster>}}} increments the value of version number in this file everytime it is called.</td>
  <td valign="top" align="left">Default: {{{false}}}</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{versionPropertyKey}}}</td>
  <td width="500" valign="top" align="left">If you were managing the version file yourself, chances are that your {{{versionFile}}} is a java properties file. Use this attribute to pass in the key name of the property against which the version number is stored.<br/><br/>
Eaxmple:
{{{
<!-- Your java properties style version file -->
build.date=Mon Aug 31 00:31:33 IST 2009
build.version=444
build.user=avlesh

<!-- Your corresponding <cacheBuster> usage -->
<cacheBuster versionFile="my-file.properties" 
             versionPropertyKey="build.version">
  <fileset dir="web"/>
  ...
</cacheBuster>
}}}
</td>
  <td valign="top" align="left">Default: {{{none}}}</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{verbose}}}</td>
  <td width="500" valign="top" align="left">See plenty of debug and info level messages on the Ant output stream.</td>
  <td valign="top" align="left">Default: {{{true}}}</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{cacheBusterPreferencesFile}}}</td>
  <td width="500" valign="top" align="left">When you want to use a file's last modified timestamp to apply cache busting rules, the {{{<cacheBuster>}}} tries to maintain the state such files in every run. This attribute is not required otherwise.</td>
  <td valign="top" align="left">Default: {{{.cache-buster.pref}}}<br/><br/>This file is saved in the project's base directory.</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{modifyOriginal}}}</td>
  <td width="500" valign="top" align="left">When set to {{{true}}}, modifies the original content of the fileset (or the file group) on which cache busting rules are applied.<br/><br/>
WARNING: You may seldom want to use this inside the {{{<powerWar>}}} task.</td>
  <td valign="top" align="left">Default: {{{false}}}</td>
 </tr>
</table>
<br/>
----
=== Cache Busting Nested Elements ===
<table cellspacing="0" cellpadding="10" border="1" width="800">
 <tr>
  <td width="100" valign="top" align="left"><b>Nested Element</b></td>
  <td width="500" valign="top" align="left"><b>Description</b></td>
  <td width="200" valign="top" align="left"><b>Remarks</b></td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{fileset}}}</td>
  <td width="500" valign="top" align="left">A group of files to which you want to apply the cache busting rules to. <br/>You can specify many fileset elements for a {{{<cacheBuster>}}}</td>
  <td width="200" valign="top" align="left">Default: {{{none}}}<br/><br/>In this case all the files being archived by the underlying "war" target go through cache busting.</td>
 </tr>
 <tr>
  <td width="100" valign="top" align="left">{{{rule}}}</td>
  <td width="500" valign="top" align="left">A single cache busting rule. You can specify more than one rule.<br/>Rule attributes:<br/>
{{{from (Required)}}}: The URL patterns which need to be replace in your {{{cacheBuster }}} fileset(s).<br/>
{{{to (Required)}}}: The URL which the {{{from}}} needs to be converted to.<br/>
{{{file (Optional)}}}: The file for which the rule is being applied. If specified, an additional file lastmodied time check is done. If the file is not modified between versions, the {{{to}}} pattern conversion takes the last version number (since the file has not been modified) into account.<br/><br/>
Examples:<br/>
{{{
<rule from="/css/(.*).css" 
      to="/css/$1.css?version=%{version-file-txt}"/>

<rule from="/js/massive.js" 
      to="/js/massive.js-%{version-file-txt}.js" 
      file="web/static-files/js/massive.js"/>
}}}
</td>
  <td width="200" valign="top" align="left">Default: {{{none}}}.</td>
 </tr>
</table>
<br/>
----
=== Cache Busting Samples ===
<b>Apply cache-busting to all Javascript links in all JSP's</b>
<br/>Scenario: Your jsp's reference a lot of Javascript files via the {{{<script>}}}'s {{{src}}} attribute. The attribute values are URL's matching the pattern {{{/static-content/js/(.*).js}}}. The easiest way to bust cache is to change this URL everytime you deploy a new build. As the client (browser) gets to see a new URL for the javascript files, it will be forced to send a new request. After receiving the response, unless instructed otherwise, browser would cache the contents of the file and keep serving it from its cache (unless expired) until you change the URL again in the next build. Look at the sample usage below -
{{{
<taskdef name="powerWar" classname="com.avlesh.antwebtasks.war.PowerWAR" classpath="/path/to/ant-web-tasks.jar"/>
<target name="my-war-target">
  <powerWar destfile="distribution/myapp.war" webxml="web/WEB-INF/web.xml" compress="true">

    <!--
       Most minimal usage of the cacheBuster feature in the PowerWAR task.
       
       The attribute "versionFile" is mandatory. cacheBuster picks up the
       content of this file and uses this as "revision number". The 
       replacement attribute, %{version-file-txt}, is populated with this
       value and can be used anywhere in the "to" attribute of the "rule" 
    -->
    <cacheBuster verbose="on" versionFile="someFile.txt">

      <!--
        Fileset(s) to apply all the rules on. This is the file group in 
        which pattern's matching a rule's "from" are found and replaced
        by their corresponding "to's"
      
        The example below is an instruction to find the URL patterns in
        all ".jsp" files inside the "web" directory.
      -->
      <fileset dir="web">
        <include name="**/*.jsp"/>
      </fileset>
      
      <!-- 
        Cache busting rule's to apply to the files above. In the example 
        below all a URL "/static-content/js/my-file.js" would be deployed
        as "/static-content/js/my-file.js?version=5" on the 5th build.
      -->
      <rule from="/static-content/js/(.*).js" 
            to="/static-content/js/$1.js?version=%{version-file-txt}"/>
    </cacheBuster>
    
    ...
  </powerWar>
</target>
}}}
<br/><br/><b>Apply cache-busting to all Javascript and CSS links in all JSP's</b>
{{{
<taskdef name="powerWar" classname="com.avlesh.antwebtasks.war.PowerWAR" classpath="/path/to/ant-web-tasks.jar"/>
<target name="my-war-target">
  <powerWar destfile="distribution/myapp.war" webxml="web/WEB-INF/web.xml" compress="true">
    <cacheBuster verbose="on" versionFile="someFile.txt">
      <fileset dir="web">
        <include name="**/*.jsp"/>
      </fileset>
      <rule from="/static-content/js/(.*).js" 
            to="/static-content/js/$1.js?version=%{version-file-txt}"/>
      <rule from="/css/(.*).css" 
            to="/css/$1.js?version=%{version-file-txt}"/>
    </cacheBuster>
    
    ...
  </powerWar>
</target>
}}}